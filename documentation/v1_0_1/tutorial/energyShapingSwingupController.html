<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Design energy shaping swing-up controller &mdash; trep documentation</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="trep documentation" href="../index.html" />
    <link rel="up" title="Tutorial" href="index.html" />
    <link rel="next" title="Calculate optimal switching time" href="optimalSwitchingTime.html" />
    <link rel="prev" title="Design linear feedback controller" href="linearFeedbackController.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="optimalSwitchingTime.html" title="Calculate optimal switching time"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="linearFeedbackController.html" title="Design linear feedback controller"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">trep documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Tutorial</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
    <script type="math/tex">
    \newcommand{\deriv}[2][]{\dfrac{\partial #1}{\partial #2}}
\newcommand{\tderiv}[2][]{\tfrac{\partial #1}{\partial #2}}
\newcommand{\fderiv}[2][]{\dfrac{d #1}{d #2}}
\newcommand{\derivII}[3][]{\dfrac{\partial^2 #1}{\partial #2 \partial #3}}
\newcommand{\tderivII}[3][]{\tfrac{\partial^2 #1}{\partial #2 \partial #3}}
\newcommand{\derivIII}[4][]{\dfrac{\partial^3 #1}{\partial #2 \partial #3 \partial #4}}
\newcommand{\tderivIII}[4][]{\tfrac{\partial^3 #1}{\partial #2 \partial #3 \partial #4}}
\newcommand{\derivIV}[5][]{\dfrac{\partial^4 #1}{\partial #2 \partial #3 \partial #4 \partial #5}}

\newcommand{\half}{\tfrac{1}{2}}  % Macro for 1/2

\newcommand{\ud}{\mathrm{d}}

\newcommand{\op}{\circ}
\newcommand{\dq}{\dot{q}}
\newcommand{\ddq}{\ddot{q}}

\newcommand{\dt}{\Delta t}


    </script>
    
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="design-energy-shaping-swing-up-controller">
<h1>Design energy shaping swing-up controller<a class="headerlink" href="#design-energy-shaping-swing-up-controller" title="Permalink to this headline">¶</a></h1>
<p>If the input torque is limited, the linear feedback controller may be unable to
bring the pendulum to the upright configuration from an arbitrary initial
condition. Let&#8217;s use trep to help create a swing-up controller based on the
energy of the system.</p>
<div class="section" id="create-pendulum-system">
<h2>Create pendulum system<a class="headerlink" href="#create-pendulum-system" title="Permalink to this headline">¶</a></h2>
<p>The code used to create the pendulum system is identical to the last section,
except a new parameter <code class="docutils literal"><span class="pre">uMax</span></code> (highlighted below) has been added that sets the
maximum absolute value of the input.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">dot</span>
<span class="kn">import</span> <span class="nn">trep</span>
<span class="kn">import</span> <span class="nn">trep.discopt</span>
<span class="kn">from</span> <span class="nn">trep</span> <span class="kn">import</span> <span class="n">tx</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">tz</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span>
<span class="kn">import</span> <span class="nn">pylab</span>

<span class="c"># Build a pendulum system</span>
<span class="n">m</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c"># Mass of pendulum</span>
<span class="n">l</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c"># Length of pendulum</span>
<span class="n">q0</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c"># Initial configuration of pendulum</span>
<span class="n">t0</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c"># Initial time</span>
<span class="n">tf</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="c"># Final time</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c"># Sampling time</span>
<span class="n">qBar</span> <span class="o">=</span> <span class="n">pi</span> <span class="c"># Desired configuration</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c"># Cost weights for states</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c"># Cost weights for inputs</span>
<span class="hll"><span class="n">uMax</span> <span class="o">=</span> <span class="mf">5.</span> <span class="c"># Max absolute input value</span>
</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">trep</span><span class="o">.</span><span class="n">System</span><span class="p">()</span> <span class="c"># Initialize system</span>

<span class="n">frames</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">rx</span><span class="p">(</span><span class="s">&#39;theta&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;pendulumShoulder&quot;</span><span class="p">),</span> <span class="p">[</span>
        <span class="n">tz</span><span class="p">(</span><span class="o">-</span><span class="n">l</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;pendulumArm&quot;</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">m</span><span class="p">)]]</span>
<span class="n">system</span><span class="o">.</span><span class="n">import_frames</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="c"># Add frames</span>

<span class="c"># Add forces to the system</span>
<span class="n">trep</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">Gravity</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.8</span><span class="p">))</span> <span class="c"># Add gravity</span>
<span class="n">trep</span><span class="o">.</span><span class="n">forces</span><span class="o">.</span><span class="n">Damping</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c"># Add damping</span>
<span class="n">trep</span><span class="o">.</span><span class="n">forces</span><span class="o">.</span><span class="n">ConfigForce</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="s">&#39;theta&#39;</span><span class="p">,</span> <span class="s">&#39;theta-torque&#39;</span><span class="p">)</span> <span class="c"># Add input</span>

<span class="c"># Create and initialize the variational integrator</span>
<span class="n">mvi</span> <span class="o">=</span> <span class="n">trep</span><span class="o">.</span><span class="n">MidpointVI</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
<span class="n">mvi</span><span class="o">.</span><span class="n">initialize_from_configs</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">q0</span><span class="p">]),</span> <span class="n">t0</span><span class="o">+</span><span class="n">dt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">q0</span><span class="p">]))</span>

<span class="c"># Create discrete system</span>
<span class="n">TVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">tf</span><span class="o">+</span><span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span> <span class="c"># Initialize discrete time vector</span>
<span class="n">dsys</span> <span class="o">=</span> <span class="n">trep</span><span class="o">.</span><span class="n">discopt</span><span class="o">.</span><span class="n">DSystem</span><span class="p">(</span><span class="n">mvi</span><span class="p">,</span> <span class="n">TVec</span><span class="p">)</span> <span class="c"># Initialize discrete system</span>
<span class="n">xBar</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">build_state</span><span class="p">(</span><span class="n">qBar</span><span class="p">)</span> <span class="c"># Create desired state configuration</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h2>Design energy shaping swing-up controller<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>It can be easily shown that a control law to stabilize a one-link pendulum to
a reference energy is</p>
<div class="math">
\[u = -K\dot{\theta}(E - \bar{E})\]</div>
<p>where <span class="math">\(E\)</span> is the current energy of the system, <span class="math">\(\bar{E}\)</span> is the
reference energy, and <span class="math">\(K\)</span> is any positive number. Therefore, the only
thing that must be done to implement the energy contoller is calculate the
reference energy and pick a positive gain value.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">system</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s">&#39;theta&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">qBar</span>
<span class="n">eBar</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">total_energy</span><span class="p">()</span>
<span class="n">KEnergy</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c"># Reset discrete system state</span>
<span class="n">dsys</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">q0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>This is done by setting the system to the desired state and using the
<a class="reference internal" href="../ref/system.html#trep.System.total_energy" title="trep.System.total_energy"><code class="xref py py-mod docutils literal"><span class="pre">trep.System.total_energy</span></code></a> method to get the desired energy level, which is
called <code class="docutils literal"><span class="pre">eBar</span></code>. The gain is set to one using <code class="docutils literal"><span class="pre">KEnergy</span> <span class="pre">=</span> <span class="pre">1</span></code>. Afterwards, the
system must be reset to its initial condition.</p>
</div>
<div class="section" id="simulate-the-system-forward">
<h2>Simulate the system forward<a class="headerlink" href="#simulate-the-system-forward" title="Permalink to this headline">¶</a></h2>
<p>The system is simulated forward in the exact same way as in the last section.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">T</span> <span class="o">=</span> <span class="p">[</span><span class="n">mvi</span><span class="o">.</span><span class="n">t1</span><span class="p">]</span> <span class="c"># List to hold time values</span>
<span class="n">Q</span> <span class="o">=</span> <span class="p">[</span><span class="n">mvi</span><span class="o">.</span><span class="n">q1</span><span class="p">]</span> <span class="c"># List to hold configuration values</span>
<span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">dsys</span><span class="o">.</span><span class="n">xk</span><span class="p">]</span> <span class="c"># List to hold state values</span>
<span class="n">U</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># List to hold input values</span>
<span class="k">while</span> <span class="n">mvi</span><span class="o">.</span><span class="n">t1</span> <span class="o">&lt;</span> <span class="n">tf</span><span class="o">-</span><span class="n">dt</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">xk</span> <span class="c"># Get current state</span>
    <span class="n">xDot</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c"># Get equivilant of angular velocity</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">total_energy</span><span class="p">()</span> <span class="c"># Get current energy of the system</span>
    <span class="n">eTilde</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">eBar</span> <span class="c"># Get difference between desired energy and current energy</span>
    <span class="c"># Calculate input</span>
    <span class="k">if</span> <span class="n">xDot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">uMax</span><span class="p">])</span> <span class="c"># Kick if necessary</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">xDot</span><span class="o">*</span><span class="n">KEnergy</span><span class="o">*</span><span class="n">eTilde</span><span class="p">])</span>
    <span class="n">u</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">uMax</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">uMax</span><span class="p">]),</span><span class="n">u</span><span class="p">))</span> <span class="c"># Constrain input</span>
    <span class="n">dsys</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="c"># Step the system forward by one time step</span>
    <span class="n">T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mvi</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span> <span class="c"># Update lists</span>
    <span class="n">Q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mvi</span><span class="o">.</span><span class="n">q1</span><span class="p">)</span>
    <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">U</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</pre></div>
</div>
<p>This time <code class="docutils literal"><span class="pre">u</span></code> is set to the energy shaping controller. Since the energy
shaping controller depends on the angular velocity it needs a &#8220;kick&#8221; if the
angular velocity is zero to get it going.</p>
<p>In addition the constraint on the input is included.</p>
</div>
<div class="section" id="visualize-the-system-in-action">
<h2>Visualize the system in action<a class="headerlink" href="#visualize-the-system-in-action" title="Permalink to this headline">¶</a></h2>
<p>The visualization is created in the exact way it was created in the previous
sections.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">trep</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">visualize_3d</span><span class="p">([</span> <span class="n">trep</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">VisualItem3D</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span> <span class="p">])</span>

<span class="c"># Plot results</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Energy Shaping Controller&quot;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;X&quot;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s">&quot;qd&quot;</span><span class="p">,</span><span class="s">&quot;p&quot;</span><span class="p">])</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">U</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;T&quot;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;U&quot;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/energyShapingSwingupController.gif" src="../_images/energyShapingSwingupController.gif" />
<p>Let&#8217;s also plot the state and input verse time.</p>
<img alt="../_images/energyShapingSwingupControllerPlot.png" src="../_images/energyShapingSwingupControllerPlot.png" />
<p>In the animation you can see that the pendulum swings-up and approaches the
upright configuration. It does not quite get there because the damping term is
not accounted for in the controller. However, it should be close enough that the
linear controller designed in the last section can take over and stabilize to
the upright configuration. Also, from the plot you can see that the input is
limited from -5 to +5.</p>
</div>
<div class="section" id="complete-code">
<h2>Complete code<a class="headerlink" href="#complete-code" title="Permalink to this headline">¶</a></h2>
<p>Below is the entire script used in this section of the tutorial.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># enerygShapingSwingupController.py</span>

<span class="c"># Import necessary python modules</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">dot</span>
<span class="kn">import</span> <span class="nn">trep</span>
<span class="kn">import</span> <span class="nn">trep.discopt</span>
<span class="kn">from</span> <span class="nn">trep</span> <span class="kn">import</span> <span class="n">tx</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">tz</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span>
<span class="kn">import</span> <span class="nn">pylab</span>

<span class="c"># Build a pendulum system</span>
<span class="n">m</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c"># Mass of pendulum</span>
<span class="n">l</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c"># Length of pendulum</span>
<span class="n">q0</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c"># Initial configuration of pendulum</span>
<span class="n">t0</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c"># Initial time</span>
<span class="n">tf</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="c"># Final time</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c"># Sampling time</span>
<span class="n">qBar</span> <span class="o">=</span> <span class="n">pi</span> <span class="c"># Desired configuration</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c"># Cost weights for states</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c"># Cost weights for inputs</span>
<span class="n">uMax</span> <span class="o">=</span> <span class="mf">5.</span> <span class="c"># Max absolute input value</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">trep</span><span class="o">.</span><span class="n">System</span><span class="p">()</span> <span class="c"># Initialize system</span>

<span class="n">frames</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">rx</span><span class="p">(</span><span class="s">&#39;theta&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;pendulumShoulder&quot;</span><span class="p">),</span> <span class="p">[</span>
        <span class="n">tz</span><span class="p">(</span><span class="o">-</span><span class="n">l</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;pendulumArm&quot;</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">m</span><span class="p">)]]</span>
<span class="n">system</span><span class="o">.</span><span class="n">import_frames</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="c"># Add frames</span>

<span class="c"># Add forces to the system</span>
<span class="n">trep</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">Gravity</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.8</span><span class="p">))</span> <span class="c"># Add gravity</span>
<span class="n">trep</span><span class="o">.</span><span class="n">forces</span><span class="o">.</span><span class="n">Damping</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c"># Add damping</span>
<span class="n">trep</span><span class="o">.</span><span class="n">forces</span><span class="o">.</span><span class="n">ConfigForce</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="s">&#39;theta&#39;</span><span class="p">,</span> <span class="s">&#39;theta-torque&#39;</span><span class="p">)</span> <span class="c"># Add input</span>

<span class="c"># Create and initialize the variational integrator</span>
<span class="n">mvi</span> <span class="o">=</span> <span class="n">trep</span><span class="o">.</span><span class="n">MidpointVI</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
<span class="n">mvi</span><span class="o">.</span><span class="n">initialize_from_configs</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">q0</span><span class="p">]),</span> <span class="n">t0</span><span class="o">+</span><span class="n">dt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">q0</span><span class="p">]))</span>

<span class="c"># Create discrete system</span>
<span class="n">TVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">tf</span><span class="o">+</span><span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span> <span class="c"># Initialize discrete time vector</span>
<span class="n">dsys</span> <span class="o">=</span> <span class="n">trep</span><span class="o">.</span><span class="n">discopt</span><span class="o">.</span><span class="n">DSystem</span><span class="p">(</span><span class="n">mvi</span><span class="p">,</span> <span class="n">TVec</span><span class="p">)</span> <span class="c"># Initialize discrete system</span>
<span class="n">xBar</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">build_state</span><span class="p">(</span><span class="n">qBar</span><span class="p">)</span> <span class="c"># Create desired state configuration</span>

<span class="c"># Design linear feedback controller</span>
<span class="n">Qd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">TVec</span><span class="p">),</span> <span class="n">dsys</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">nQ</span><span class="p">))</span> <span class="c"># Initialize desired configuration trajectory</span>
<span class="n">thetaIndex</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s">&#39;theta&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span> <span class="c"># Find index of theta config variable</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">TVec</span><span class="p">):</span>
    <span class="n">Qd</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">thetaIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">qBar</span> <span class="c"># Set desired configuration trajectory</span>
    <span class="p">(</span><span class="n">Xd</span><span class="p">,</span> <span class="n">Ud</span><span class="p">)</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">build_trajectory</span><span class="p">(</span><span class="n">Qd</span><span class="p">)</span> <span class="c"># Set desired state and input trajectory</span>

<span class="n">Qk</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">Q</span> <span class="c"># Create lambda function for state cost weights</span>
<span class="n">Rk</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">R</span> <span class="c"># Create lambda function for input cost weights</span>
<span class="n">KVec</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">calc_feedback_controller</span><span class="p">(</span><span class="n">Xd</span><span class="p">,</span> <span class="n">Ud</span><span class="p">,</span> <span class="n">Qk</span><span class="p">,</span> <span class="n">Rk</span><span class="p">)</span> <span class="c"># Solve for linear feedback controller gain</span>
<span class="n">KStabilize</span> <span class="o">=</span> <span class="n">KVec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c"># Use only use first value to approximate infinite-horizon optimal controller gain</span>

<span class="c"># Design energy shaping swing-up controller</span>
<span class="n">system</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s">&#39;theta&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">qBar</span>
<span class="n">eBar</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">total_energy</span><span class="p">()</span>
<span class="n">KEnergy</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c"># Reset discrete system state</span>
<span class="n">dsys</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">q0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>

<span class="c"># Simulate the system forward</span>
<span class="n">T</span> <span class="o">=</span> <span class="p">[</span><span class="n">mvi</span><span class="o">.</span><span class="n">t1</span><span class="p">]</span> <span class="c"># List to hold time values</span>
<span class="n">Q</span> <span class="o">=</span> <span class="p">[</span><span class="n">mvi</span><span class="o">.</span><span class="n">q1</span><span class="p">]</span> <span class="c"># List to hold configuration values</span>
<span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">dsys</span><span class="o">.</span><span class="n">xk</span><span class="p">]</span> <span class="c"># List to hold state values</span>
<span class="n">U</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># List to hold input values</span>
<span class="k">while</span> <span class="n">mvi</span><span class="o">.</span><span class="n">t1</span> <span class="o">&lt;</span> <span class="n">tf</span><span class="o">-</span><span class="n">dt</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">xk</span> <span class="c"># Get current state</span>
    <span class="n">xDot</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c"># Get equivilant of angular velocity</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">total_energy</span><span class="p">()</span> <span class="c"># Get current energy of the system</span>
    <span class="n">eTilde</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">eBar</span> <span class="c"># Get difference between desired energy and current energy</span>
    <span class="c"># Calculate input</span>
    <span class="k">if</span> <span class="n">xDot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">uMax</span><span class="p">])</span> <span class="c"># Kick if necessary</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">xDot</span><span class="o">*</span><span class="n">KEnergy</span><span class="o">*</span><span class="n">eTilde</span><span class="p">])</span>
    <span class="n">u</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">uMax</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">uMax</span><span class="p">]),</span><span class="n">u</span><span class="p">))</span> <span class="c"># Constrain input</span>
    <span class="n">dsys</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="c"># Step the system forward by one time step</span>
    <span class="n">T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mvi</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span> <span class="c"># Update lists</span>
    <span class="n">Q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mvi</span><span class="o">.</span><span class="n">q1</span><span class="p">)</span>
    <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">U</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>

<span class="c"># Visualize the system in action</span>
<span class="n">trep</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">visualize_3d</span><span class="p">([</span> <span class="n">trep</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">VisualItem3D</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span> <span class="p">])</span>

<span class="c"># Plot results</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Energy Shaping Controller&quot;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;X&quot;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s">&quot;qd&quot;</span><span class="p">,</span><span class="s">&quot;p&quot;</span><span class="p">])</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">U</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;T&quot;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;U&quot;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


          </div>
        </div>
      </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
    <h2><a href="http://murpheylab.github.io/trep/">Project Website</a></h2>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Design energy shaping swing-up controller</a><ul>
<li><a class="reference internal" href="#create-pendulum-system">Create pendulum system</a></li>
<li><a class="reference internal" href="#id1">Design energy shaping swing-up controller</a></li>
<li><a class="reference internal" href="#simulate-the-system-forward">Simulate the system forward</a></li>
<li><a class="reference internal" href="#visualize-the-system-in-action">Visualize the system in action</a></li>
<li><a class="reference internal" href="#complete-code">Complete code</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="linearFeedbackController.html"
                        title="previous chapter">Design linear feedback controller</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="optimalSwitchingTime.html"
                        title="next chapter">Calculate optimal switching time</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/tutorial/energyShapingSwingupController.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="optimalSwitchingTime.html" title="Calculate optimal switching time"
             >next</a> |</li>
        <li class="right" >
          <a href="linearFeedbackController.html" title="Design linear feedback controller"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">trep documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Tutorial</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Elliot Johnson.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>