<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Calculate optimal switching time &mdash; trep documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.92-dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="trep documentation" href="../index.html" />
    <link rel="up" title="Tutorial" href="index.html" />
    <link rel="next" title="User’s Guide" href="../user_guide/index.html" />
    <link rel="prev" title="Design energy shaping swing-up controller" href="energyShapingSwingupController.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../user_guide/index.html" title="User’s Guide"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="energyShapingSwingupController.html" title="Design energy shaping swing-up controller"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">trep documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Tutorial</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
    <script type="math/tex">
    \newcommand{\deriv}[2][]{\dfrac{\partial #1}{\partial #2}}
\newcommand{\tderiv}[2][]{\tfrac{\partial #1}{\partial #2}}
\newcommand{\fderiv}[2][]{\dfrac{d #1}{d #2}}
\newcommand{\derivII}[3][]{\dfrac{\partial^2 #1}{\partial #2 \partial #3}}
\newcommand{\tderivII}[3][]{\tfrac{\partial^2 #1}{\partial #2 \partial #3}}
\newcommand{\derivIII}[4][]{\dfrac{\partial^3 #1}{\partial #2 \partial #3 \partial #4}}
\newcommand{\tderivIII}[4][]{\tfrac{\partial^3 #1}{\partial #2 \partial #3 \partial #4}}
\newcommand{\derivIV}[5][]{\dfrac{\partial^4 #1}{\partial #2 \partial #3 \partial #4 \partial #5}}

\newcommand{\half}{\tfrac{1}{2}}  % Macro for 1/2

\newcommand{\ud}{\mathrm{d}}

\newcommand{\op}{\circ}
\newcommand{\dq}{\dot{q}}
\newcommand{\ddq}{\ddot{q}}

\newcommand{\dt}{\Delta t}


    </script>
    
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="calculate-optimal-switching-time">
<h1>Calculate optimal switching time<a class="headerlink" href="#calculate-optimal-switching-time" title="Permalink to this headline">¶</a></h1>
<p>Now let us calculate the optimal time to switch between the energy shaping
swing-up controller and the linear feedback stabilizing controller. In order to
determine this time, tools from optimal control are employed; however, the
details of why these tools work is not explained here. The point is to show how
trep facilitates the implementation because it has already precomputed all the
necessary derivatives.</p>
<div class="section" id="create-pendulum-system">
<h2>Create pendulum system<a class="headerlink" href="#create-pendulum-system" title="Permalink to this headline">¶</a></h2>
<p>The code used to create the pendulum system and the controllers is identical to
the previous sections, except a new variable has been added that designates the
switching time. This is initially set to an initial guess equal to one-half the
final time. We will then use this initial guess to find the optimal switching
time. This variable is <tt class="docutils literal"><span class="pre">tau</span></tt> is highlighted in the code below.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">dot</span>
<span class="kn">import</span> <span class="nn">trep</span>
<span class="kn">import</span> <span class="nn">trep.discopt</span>
<span class="kn">from</span> <span class="nn">trep</span> <span class="kn">import</span> <span class="n">tx</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">tz</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span>
<span class="kn">import</span> <span class="nn">pylab</span>

<span class="c"># Build a pendulum system</span>
<span class="n">m</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c"># Mass of pendulum</span>
<span class="n">l</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c"># Length of pendulum</span>
<span class="n">q0</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c"># Initial configuration of pendulum</span>
<span class="n">t0</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c"># Initial time</span>
<span class="n">tf</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="c"># Final time</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="c"># Sampling time</span>
<span class="n">qBar</span> <span class="o">=</span> <span class="n">pi</span> <span class="c"># Desired configuration</span>
<span class="n">Qi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c"># Cost weights for states</span>
<span class="n">Ri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c"># Cost weights for inputs</span>
<span class="n">uMax</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="c"># Max absolute input value</span>
<span class="hll"><span class="n">tau</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="c"># Switching time</span>
</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">trep</span><span class="o">.</span><span class="n">System</span><span class="p">()</span> <span class="c"># Initialize system</span>

<span class="n">frames</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">rx</span><span class="p">(</span><span class="s">&#39;theta&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;pendulumShoulder&quot;</span><span class="p">),</span> <span class="p">[</span>
        <span class="n">tz</span><span class="p">(</span><span class="o">-</span><span class="n">l</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;pendulumArm&quot;</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">m</span><span class="p">)]]</span>
<span class="n">system</span><span class="o">.</span><span class="n">import_frames</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="c"># Add frames</span>

<span class="c"># Add forces to the system</span>
<span class="n">trep</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">Gravity</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.8</span><span class="p">))</span> <span class="c"># Add gravity</span>
<span class="n">trep</span><span class="o">.</span><span class="n">forces</span><span class="o">.</span><span class="n">Damping</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c"># Add damping</span>
<span class="n">trep</span><span class="o">.</span><span class="n">forces</span><span class="o">.</span><span class="n">ConfigForce</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="s">&#39;theta&#39;</span><span class="p">,</span> <span class="s">&#39;theta-torque&#39;</span><span class="p">)</span> <span class="c"># Add input</span>

<span class="c"># Create and initialize the variational integrator</span>
<span class="n">mvi</span> <span class="o">=</span> <span class="n">trep</span><span class="o">.</span><span class="n">MidpointVI</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
<span class="n">mvi</span><span class="o">.</span><span class="n">initialize_from_configs</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">q0</span><span class="p">]),</span> <span class="n">t0</span><span class="o">+</span><span class="n">dt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">q0</span><span class="p">]))</span>

<span class="c"># Create discrete system</span>
<span class="n">TVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">tf</span><span class="o">+</span><span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span> <span class="c"># Initialize discrete time vector</span>
<span class="n">dsys</span> <span class="o">=</span> <span class="n">trep</span><span class="o">.</span><span class="n">discopt</span><span class="o">.</span><span class="n">DSystem</span><span class="p">(</span><span class="n">mvi</span><span class="p">,</span> <span class="n">TVec</span><span class="p">)</span> <span class="c"># Initialize discrete system</span>
<span class="n">xBar</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">build_state</span><span class="p">(</span><span class="n">qBar</span><span class="p">)</span> <span class="c"># Create desired state configuration</span>

<span class="c"># Design linear feedback controller</span>
<span class="n">Qd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">TVec</span><span class="p">),</span> <span class="n">dsys</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">nQ</span><span class="p">))</span> <span class="c"># Initialize desired configuration trajectory</span>
<span class="n">thetaIndex</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s">&#39;theta&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span> <span class="c"># Find index of theta config variable</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">TVec</span><span class="p">):</span>
    <span class="n">Qd</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">thetaIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">qBar</span> <span class="c"># Set desired configuration trajectory</span>
    <span class="p">(</span><span class="n">Xd</span><span class="p">,</span> <span class="n">Ud</span><span class="p">)</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">build_trajectory</span><span class="p">(</span><span class="n">Qd</span><span class="p">)</span> <span class="c"># Set desired state and input trajectory</span>

<span class="n">Qk</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">Qi</span> <span class="c"># Create lambda function for state cost weights</span>
<span class="n">Rk</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">Ri</span> <span class="c"># Create lambda function for input cost weights</span>
<span class="n">KVec</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">calc_feedback_controller</span><span class="p">(</span><span class="n">Xd</span><span class="p">,</span> <span class="n">Ud</span><span class="p">,</span> <span class="n">Qk</span><span class="p">,</span> <span class="n">Rk</span><span class="p">)</span> <span class="c"># Solve for linear feedback controller gain</span>
<span class="n">KStabilize</span> <span class="o">=</span> <span class="n">KVec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c"># Use only use first value to approximate infinite-horizon optimal controller gain</span>

<span class="c"># Design energy shaping swing-up controller</span>
<span class="n">system</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s">&#39;theta&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">qBar</span>
<span class="n">eBar</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">total_energy</span><span class="p">()</span>
<span class="n">KEnergy</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="section" id="create-cost">
<h2>Create cost<a class="headerlink" href="#create-cost" title="Permalink to this headline">¶</a></h2>
<p>In order to perform an optimization anything there must be some sort of cost
functional that is desirable to minimize. Trep has built in objects to deal with
cost functions and that is what is used here.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">cost</span> <span class="o">=</span> <span class="n">trep</span><span class="o">.</span><span class="n">discopt</span><span class="o">.</span><span class="n">DCost</span><span class="p">(</span><span class="n">Xd</span><span class="p">,</span> <span class="n">Ud</span><span class="p">,</span> <span class="n">Qi</span><span class="p">,</span> <span class="n">Ri</span><span class="p">)</span>
</pre></div>
</div>
<p>The cost object is created with the <a class="reference internal" href="../ref/dcost.html#trep.discopt.DCost" title="trep.discopt.DCost"><tt class="xref py py-mod docutils literal"><span class="pre">trep.discopt.DCost</span></tt></a> method, which
takes in a state trajectory, input trajectory, state weighting matrix, and input
weighting matrix.</p>
<p>In this case we used the same trajectories and weights that were used for the
design of the linear feedback controller that stabilizes the pendulum to the
upright unstable equilibrium.</p>
<p>Below is a list of the properties and methods of the cost class.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">cost</span><span class="o">.</span>
<span class="go">cost.Q       cost.R       cost.l_du    cost.l_dx    cost.l_dxdx  cost.m_dx    cost.ud</span>
<span class="go">cost.Qf      cost.l       cost.l_dudu  cost.l_dxdu  cost.m       cost.m_dxdx  cost.xd</span>
</pre></div>
</div>
<p>Please refer to the <a class="reference internal" href="../ref/dcost.html#trep-dcost"><em>Discrete Trajectory Cost</em></a> documentation
to learn more this object.</p>
</div>
<div class="section" id="angle-utility-functions">
<h2>Angle utility functions<a class="headerlink" href="#angle-utility-functions" title="Permalink to this headline">¶</a></h2>
<p>Since we would like the <a class="reference internal" href="linearFeedbackController.html"><em>stabilizing controller</em></a>
to stabilize to any multiple of <span class="math">\(\pi\)</span>, two helper functions are used to
wrap the angles to between <span class="math">\(0\)</span> and <span class="math">\(2\pi\)</span> and between <span class="math">\(-\pi\)</span>
and <span class="math">\(\pi\)</span>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">wrapTo2Pi</span><span class="p">(</span><span class="n">ang</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ang</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">wrapToPi</span><span class="p">(</span><span class="n">ang</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">ang</span> <span class="o">+</span> <span class="n">pi</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="n">pi</span>
</pre></div>
</div>
</div>
<div class="section" id="simulate-function">
<h2>Simulate function<a class="headerlink" href="#simulate-function" title="Permalink to this headline">¶</a></h2>
<p>The simulation of the system is done exactly the same way as in previous
sections, except this time the forward simulation is wrapped into its own
function. This makes running the optimization simpler because the simulate
function can be called with different switching times instead of having to have
multiple copies of the same code.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">simulateForward</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">dsys</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">xBar</span><span class="p">):</span>
    <span class="n">mvi</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">varint</span>
    <span class="n">tf</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c"># Reset discrete system state</span>
    <span class="n">dsys</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">q0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c"># Initial conditions</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">k</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">mvi</span><span class="o">.</span><span class="n">q1</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">xk</span>
    <span class="n">fdx</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">fdx</span><span class="p">()</span>
    <span class="n">xTilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wrapToPi</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xBar</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">total_energy</span><span class="p">()</span> <span class="c"># Get current energy of the system</span>
    <span class="n">eTilde</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">eBar</span> <span class="c"># Get difference between desired energy and current energy</span>

    <span class="c"># Initial list variables</span>
    <span class="n">K</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="c"># List to hold discrete update count</span>
    <span class="n">T</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="c"># List to hold time values</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="c"># List to hold configuration values</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="c"># List to hold state values</span>
    <span class="n">Fdx</span> <span class="o">=</span> <span class="p">[</span><span class="n">fdx</span><span class="p">]</span> <span class="c"># List to hold partial to x</span>
    <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="c"># List to hold energy values</span>
    <span class="n">U</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># List to hold input values</span>
    <span class="n">L</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># List to hold cost values</span>

    <span class="c"># Simulate the system forward</span>
    <span class="k">while</span> <span class="n">mvi</span><span class="o">.</span><span class="n">t1</span> <span class="o">&lt;</span> <span class="n">tf</span><span class="o">-</span><span class="n">dt</span><span class="p">:</span>
<span class="hll">        <span class="k">if</span> <span class="n">mvi</span><span class="o">.</span><span class="n">t1</span> <span class="o">&lt;</span> <span class="n">tau</span><span class="p">:</span>
</span>            <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">uMax</span><span class="p">])</span> <span class="c"># Kick if necessary</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">KEnergy</span><span class="o">*</span><span class="n">eTilde</span><span class="p">])</span> <span class="c"># Swing-up controller</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="o">-</span><span class="n">dot</span><span class="p">(</span><span class="n">KStabilize</span><span class="p">,</span> <span class="n">xTilde</span><span class="p">)</span> <span class="c"># Stabilizing controller</span>
        <span class="n">u</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">uMax</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">uMax</span><span class="p">]),</span> <span class="n">u</span><span class="p">))</span> <span class="c"># Constrain input</span>

        <span class="n">dsys</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="c"># Step the system forward by one time step</span>

        <span class="c"># Update variables</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">k</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">TVec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">mvi</span><span class="o">.</span><span class="n">q1</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">xk</span>
<span class="hll">        <span class="n">fdx</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">fdx</span><span class="p">()</span>
</span>        <span class="n">xTilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wrapToPi</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xBar</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">total_energy</span><span class="p">()</span>
        <span class="n">eTilde</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">eBar</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">cost</span><span class="o">.</span><span class="n">l</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wrapTo2Pi</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span> <span class="n">u</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

        <span class="c"># Append to lists</span>
        <span class="n">K</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">Q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">Fdx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fdx</span><span class="p">)</span>
        <span class="n">E</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">U</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">L</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

    <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Fdx</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span>
</pre></div>
</div>
<p>The choice of which controller to use within the simulation function is decided
based on if the simulation time is less than the switching time (highlighted
above). If the simulation time is less than <tt class="docutils literal"><span class="pre">tau</span></tt> then the swing-up controller
is used, otherwise the linear stabilizing controller is used.  Also note that we
store and return a vector of the derivatives of the dynamics with respect to the
state (highlighted above) i.e. <a class="reference internal" href="../ref/dsystem.html#trep.discopt.DSystem.fdx" title="trep.discopt.DSystem.fdx"><tt class="xref py py-mod docutils literal"><span class="pre">trep.discopt.DSystem.fdx</span></tt></a>.</p>
</div>
<div class="section" id="optimize">
<h2>Optimize<a class="headerlink" href="#optimize" title="Permalink to this headline">¶</a></h2>
<p>The optimization of the switching time is done in the standard way of using a
gradient decent method to minimize a cost function with respect to the switching
time. Both a descent direction and a step size must be calculated. The negative
gradient of the cost to the switching time is used for the descent
direction. Therefore, the switching time is updated with the following</p>
<div class="math">
\[\tau(k+1) = \tau(k) - \gamma*\frac{\partial J}{\partial \tau(k)}\]</div>
<p>where <span class="math">\(\tau\)</span> is the switching time, <span class="math">\(\gamma\)</span> is the step size, and
<span class="math">\(J\)</span> is the cost function.</p>
<p>To calculate the negative gradient in each iteration of the optimization, first
the system is simulated forward from the initial time to the final time. Then
the costate of the system is simulated backward from the final time to the
switching time. The gradient at the switching time is the inner product of the
difference between the two control laws and the costate.</p>
<p>Trep greatly simplifies this calculation because it has already calculated the
necessary derivatives. In the simulation function the derivative of the system
with respect to <span class="math">\(x\)</span> (highlighted above) is stored at each time
instance. Also, the derivative of the cost with respect to <span class="math">\(x\)</span> has been
already calculated with trep. Both of these derivatives are used in the backward
simulation of the costate (highlighted below).</p>
<p>An Armijo line search is used to calculate the step size in each iteration of
the optimization.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">Tau</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">JVec</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">JdTau</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s">&#39;Inf&#39;</span><span class="p">)</span>
<span class="k">while</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">JdTau</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mo">001</span><span class="p">:</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c"># Simulate forward from 0 to tf</span>
    <span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Fdx</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span> <span class="o">=</span> <span class="n">simulateForward</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">dsys</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">xBar</span><span class="p">)</span>

    <span class="c"># Simulate backward from tf to tau</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">lam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="k">while</span> <span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tau</span> <span class="o">+</span> <span class="n">dt</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
<span class="hll">       <span class="n">lamDx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cost</span><span class="o">.</span><span class="n">l_dx</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">U</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">k</span><span class="p">)])</span>
</span><span class="hll">       <span class="n">f2Dx</span> <span class="o">=</span> <span class="n">Fdx</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span>       <span class="n">lamDt</span> <span class="o">=</span> <span class="o">-</span><span class="n">lamDx</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">f2Dx</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">lam</span><span class="p">)</span>
       <span class="n">lam</span> <span class="o">=</span> <span class="n">lam</span> <span class="o">-</span> <span class="n">lamDt</span><span class="o">*</span><span class="n">dt</span>
       <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c"># Calculate dynamics of swing-up controller at switching time</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">xTilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wrapToPi</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xBar</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="o">-</span><span class="n">dot</span><span class="p">(</span><span class="n">KStabilize</span><span class="p">,</span> <span class="n">xTilde</span><span class="p">)</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">uMax</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">uMax</span><span class="p">]),</span> <span class="n">u1</span><span class="p">))</span>
    <span class="n">dsys</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">u1</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">f</span><span class="p">()</span>

    <span class="c"># Calculate dynamics of stabilizing controller at switching time</span>
    <span class="n">eTilde</span> <span class="o">=</span> <span class="n">E</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">eBar</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">KEnergy</span><span class="o">*</span><span class="n">eTilde</span><span class="p">])</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">uMax</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">uMax</span><span class="p">]),</span> <span class="n">u2</span><span class="p">))</span>
    <span class="n">dsys</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">u2</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">f</span><span class="p">()</span>

    <span class="c"># Calculate value  of change in cost to change in switch time</span>
    <span class="n">JdTau</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">f1</span><span class="o">-</span><span class="n">f2</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>

    <span class="c"># Armijo - used to determine step size</span>
    <span class="n">chi</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="o">.</span><span class="mi">1</span>
    <span class="n">tauTemp</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">-</span> <span class="p">(</span><span class="n">alpha</span><span class="o">**</span><span class="n">chi</span><span class="p">)</span><span class="o">*</span><span class="n">JdTau</span>
    <span class="p">(</span><span class="n">KTemp</span><span class="p">,</span> <span class="n">TTemp</span><span class="p">,</span> <span class="n">QTemp</span><span class="p">,</span> <span class="n">XTemp</span><span class="p">,</span> <span class="n">FdxTemp</span><span class="p">,</span> <span class="n">ETemp</span><span class="p">,</span> <span class="n">UTemp</span><span class="p">,</span> <span class="n">LTemp</span><span class="p">,</span> <span class="n">JTemp</span><span class="p">)</span> <span class="o">=</span> <span class="n">simulateForward</span><span class="p">(</span><span class="n">tauTemp</span><span class="p">,</span> <span class="n">dsys</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">xBar</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">JTemp</span> <span class="o">&gt;</span> <span class="n">J</span> <span class="o">+</span> <span class="p">(</span><span class="n">alpha</span><span class="o">**</span><span class="n">chi</span><span class="p">)</span><span class="o">*</span><span class="n">beta</span><span class="o">*</span><span class="p">(</span><span class="n">JdTau</span><span class="o">**</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">tauTemp</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">-</span> <span class="p">(</span><span class="n">alpha</span><span class="o">**</span><span class="n">chi</span><span class="p">)</span><span class="o">*</span><span class="n">JdTau</span>
        <span class="p">(</span><span class="n">KTemp</span><span class="p">,</span> <span class="n">TTemp</span><span class="p">,</span> <span class="n">QTemp</span><span class="p">,</span> <span class="n">XTemp</span><span class="p">,</span> <span class="n">FdxTemp</span><span class="p">,</span> <span class="n">ETemp</span><span class="p">,</span> <span class="n">UTemp</span><span class="p">,</span> <span class="n">LTemp</span><span class="p">,</span> <span class="n">JTemp</span><span class="p">)</span> <span class="o">=</span> <span class="n">simulateForward</span><span class="p">(</span><span class="n">tauTemp</span><span class="p">,</span> <span class="n">dsys</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">xBar</span><span class="p">)</span>
        <span class="n">chi</span> <span class="o">=</span> <span class="n">chi</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">**</span><span class="n">chi</span> <span class="c"># Step size</span>

    <span class="c"># Calculate new switching time</span>
    <span class="n">tauPlus</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">-</span> <span class="n">gamma</span><span class="o">*</span><span class="n">JdTau</span>

    <span class="c"># Print iteration results</span>
    <span class="k">print</span> <span class="s">&quot;Optimization iteration: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cnt</span>
    <span class="k">print</span> <span class="s">&quot;Current switch time: </span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">tau</span>
    <span class="k">print</span> <span class="s">&quot;New switch time: </span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">tauPlus</span>
    <span class="k">print</span> <span class="s">&quot;Current cost: </span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">J</span>
    <span class="k">print</span> <span class="s">&quot;Parital of cost to switch time: </span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">JdTau</span>
    <span class="k">print</span> <span class="s">&quot;&quot;</span>

    <span class="c"># Update to  new switching time</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="n">tauPlus</span>

<span class="k">print</span> <span class="s">&quot;Optimal switch time: </span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">tau</span>
</pre></div>
</div>
<p>The results of each iteration are then printed to the screen. The optimization
stops when the gradient is smaller than 0.001 or the number iteration is 10 or
more. Once the optimization completes the optimal switching time is printed to
the screen.</p>
</div>
<div class="section" id="simulate-with-optimal-switching-time">
<h2>Simulate with optimal switching time<a class="headerlink" href="#simulate-with-optimal-switching-time" title="Permalink to this headline">¶</a></h2>
<p>Once the optimal switching time is calculated the system can be simulated
forward from its initial configuration. It will reach its desired configuration
given the constrained input by switching between the two controllers. In
addition, this switch is performed at the optimal time.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Fdx</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span> <span class="o">=</span> <span class="n">simulateForward</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">dsys</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">xBar</span><span class="p">)</span>
</pre></div>
</div>
<p>From the output of the simulation you can see that it take 3 iteration to
converge to the optimal switching time of 4.63.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="o">%</span><span class="n">run</span> <span class="n">optimalSwitchingTime</span><span class="o">.</span><span class="n">py</span>
<span class="go">Optimization iteration: 1</span>
<span class="go">Current switch time: 5.00</span>
<span class="go">New switch time: 4.79</span>
<span class="go">Current cost: 9680.81</span>
<span class="go">Parital of cost to switch time: 1.70</span>
<span class="go">---</span>
<span class="go">Optimization iteration: 2</span>
<span class="go">Current switch time: 4.79</span>
<span class="go">New switch time: 4.63</span>
<span class="go">Current cost: 9214.82</span>
<span class="go">Parital of cost to switch time: 0.62</span>
<span class="go">---</span>
<span class="go">Optimization iteration: 3</span>
<span class="go">Current switch time: 4.63</span>
<span class="go">New switch time: 4.63</span>
<span class="go">Current cost: 9204.84</span>
<span class="go">Parital of cost to switch time: 0.00</span>
<span class="go">---</span>
<span class="go">Optimal switch time: 4.63</span>
</pre></div>
</div>
</div>
<div class="section" id="visualize-the-system-in-action">
<h2>Visualize the system in action<a class="headerlink" href="#visualize-the-system-in-action" title="Permalink to this headline">¶</a></h2>
<p>The visualization is created just as in previous sections.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">trep</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">visualize_3d</span><span class="p">([</span> <span class="n">trep</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">VisualItem3D</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span> <span class="p">])</span>

<span class="c"># Plot results</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">311</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Swing-up and stabilize with optimal switching time&quot;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;X&quot;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s">&quot;qd&quot;</span><span class="p">,</span><span class="s">&quot;p&quot;</span><span class="p">])</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">312</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">U</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;T&quot;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;U&quot;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">313</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">L</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;T&quot;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;L&quot;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/optimalSwitchingTime.gif" src="../_images/optimalSwitchingTime.gif" />
<p>Let&#8217;s also plot the state, input, and cost verse time.</p>
<img alt="../_images/optimalSwitchingTimePlot.png" src="../_images/optimalSwitchingTimePlot.png" />
<p>Just for reference the cost verse switching time is shown for all switching
times from time zero to the final time. You can see that the optimization does
find a switching time with a local minimum in the cost. Clearly, this cost verse
switching time is non-convex, thus our gradient descent method only finds a
local minimizer, and not a global minimizer.</p>
<img alt="../_images/bruteForceOptimize.png" src="../_images/bruteForceOptimize.png" />
</div>
<div class="section" id="optimalswitchingtime-py-code">
<h2>optimalSwitchingTime.py code<a class="headerlink" href="#optimalswitchingtime-py-code" title="Permalink to this headline">¶</a></h2>
<p>Below is the entire script used in this section of the tutorial.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># optimalSwitchingTime.py</span>

<span class="c"># Import necessary python modules</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">dot</span>
<span class="kn">import</span> <span class="nn">trep</span>
<span class="kn">import</span> <span class="nn">trep.discopt</span>
<span class="kn">from</span> <span class="nn">trep</span> <span class="kn">import</span> <span class="n">tx</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">tz</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span>
<span class="kn">import</span> <span class="nn">pylab</span>

<span class="c"># Build a pendulum system</span>
<span class="n">m</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c"># Mass of pendulum</span>
<span class="n">l</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c"># Length of pendulum</span>
<span class="n">q0</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c"># Initial configuration of pendulum</span>
<span class="n">t0</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c"># Initial time</span>
<span class="n">tf</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="c"># Final time</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="c"># Sampling time</span>
<span class="n">qBar</span> <span class="o">=</span> <span class="n">pi</span> <span class="c"># Desired configuration</span>
<span class="n">Qi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c"># Cost weights for states</span>
<span class="n">Ri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c"># Cost weights for inputs</span>
<span class="n">uMax</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="c"># Max absolute input value</span>
<span class="n">tau</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="c"># Switching time</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">trep</span><span class="o">.</span><span class="n">System</span><span class="p">()</span> <span class="c"># Initialize system</span>

<span class="n">frames</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">rx</span><span class="p">(</span><span class="s">&#39;theta&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;pendulumShoulder&quot;</span><span class="p">),</span> <span class="p">[</span>
        <span class="n">tz</span><span class="p">(</span><span class="o">-</span><span class="n">l</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;pendulumArm&quot;</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">m</span><span class="p">)]]</span>
<span class="n">system</span><span class="o">.</span><span class="n">import_frames</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="c"># Add frames</span>

<span class="c"># Add forces to the system</span>
<span class="n">trep</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">Gravity</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">9.8</span><span class="p">))</span> <span class="c"># Add gravity</span>
<span class="n">trep</span><span class="o">.</span><span class="n">forces</span><span class="o">.</span><span class="n">Damping</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c"># Add damping</span>
<span class="n">trep</span><span class="o">.</span><span class="n">forces</span><span class="o">.</span><span class="n">ConfigForce</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="s">&#39;theta&#39;</span><span class="p">,</span> <span class="s">&#39;theta-torque&#39;</span><span class="p">)</span> <span class="c"># Add input</span>

<span class="c"># Create and initialize the variational integrator</span>
<span class="n">mvi</span> <span class="o">=</span> <span class="n">trep</span><span class="o">.</span><span class="n">MidpointVI</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
<span class="n">mvi</span><span class="o">.</span><span class="n">initialize_from_configs</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">q0</span><span class="p">]),</span> <span class="n">t0</span><span class="o">+</span><span class="n">dt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">q0</span><span class="p">]))</span>

<span class="c"># Create discrete system</span>
<span class="n">TVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">tf</span><span class="o">+</span><span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span> <span class="c"># Initialize discrete time vector</span>
<span class="n">dsys</span> <span class="o">=</span> <span class="n">trep</span><span class="o">.</span><span class="n">discopt</span><span class="o">.</span><span class="n">DSystem</span><span class="p">(</span><span class="n">mvi</span><span class="p">,</span> <span class="n">TVec</span><span class="p">)</span> <span class="c"># Initialize discrete system</span>
<span class="n">xBar</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">build_state</span><span class="p">(</span><span class="n">qBar</span><span class="p">)</span> <span class="c"># Create desired state configuration</span>

<span class="c"># Design linear feedback controller</span>
<span class="n">Qd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">TVec</span><span class="p">),</span> <span class="n">dsys</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">nQ</span><span class="p">))</span> <span class="c"># Initialize desired configuration trajectory</span>
<span class="n">thetaIndex</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s">&#39;theta&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span> <span class="c"># Find index of theta config variable</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">TVec</span><span class="p">):</span>
    <span class="n">Qd</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">thetaIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">qBar</span> <span class="c"># Set desired configuration trajectory</span>
    <span class="p">(</span><span class="n">Xd</span><span class="p">,</span> <span class="n">Ud</span><span class="p">)</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">build_trajectory</span><span class="p">(</span><span class="n">Qd</span><span class="p">)</span> <span class="c"># Set desired state and input trajectory</span>

<span class="n">Qk</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">Qi</span> <span class="c"># Create lambda function for state cost weights</span>
<span class="n">Rk</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">Ri</span> <span class="c"># Create lambda function for input cost weights</span>
<span class="n">KVec</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">calc_feedback_controller</span><span class="p">(</span><span class="n">Xd</span><span class="p">,</span> <span class="n">Ud</span><span class="p">,</span> <span class="n">Qk</span><span class="p">,</span> <span class="n">Rk</span><span class="p">)</span> <span class="c"># Solve for linear feedback controller gain</span>
<span class="n">KStabilize</span> <span class="o">=</span> <span class="n">KVec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c"># Use only use first value to approximate infinite-horizon optimal controller gain</span>

<span class="c"># Design energy shaping swing-up controller</span>
<span class="n">system</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s">&#39;theta&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">qBar</span>
<span class="n">eBar</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">total_energy</span><span class="p">()</span>
<span class="n">KEnergy</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c"># Create cost</span>
<span class="n">cost</span> <span class="o">=</span> <span class="n">trep</span><span class="o">.</span><span class="n">discopt</span><span class="o">.</span><span class="n">DCost</span><span class="p">(</span><span class="n">Xd</span><span class="p">,</span> <span class="n">Ud</span><span class="p">,</span> <span class="n">Qi</span><span class="p">,</span> <span class="n">Ri</span><span class="p">)</span>

<span class="c"># Helper functions</span>
<span class="k">def</span> <span class="nf">wrapTo2Pi</span><span class="p">(</span><span class="n">ang</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ang</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">wrapToPi</span><span class="p">(</span><span class="n">ang</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">ang</span> <span class="o">+</span> <span class="n">pi</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="n">pi</span>

<span class="k">def</span> <span class="nf">simulateForward</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">dsys</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">xBar</span><span class="p">):</span>
    <span class="n">mvi</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">varint</span>
    <span class="n">tf</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c"># Reset discrete system state</span>
    <span class="n">dsys</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">q0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c"># Initial conditions</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">k</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">mvi</span><span class="o">.</span><span class="n">q1</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">xk</span>
    <span class="n">fdx</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">fdx</span><span class="p">()</span>
    <span class="n">xTilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wrapToPi</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xBar</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">total_energy</span><span class="p">()</span> <span class="c"># Get current energy of the system</span>
    <span class="n">eTilde</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">eBar</span> <span class="c"># Get difference between desired energy and current energy</span>

    <span class="c"># Initial list variables</span>
    <span class="n">K</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="c"># List to hold discrete update count</span>
    <span class="n">T</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="c"># List to hold time values</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="c"># List to hold configuration values</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="c"># List to hold state values</span>
    <span class="n">Fdx</span> <span class="o">=</span> <span class="p">[</span><span class="n">fdx</span><span class="p">]</span> <span class="c"># List to hold partial to x</span>
    <span class="n">E</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="c"># List to hold energy values</span>
    <span class="n">U</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># List to hold input values</span>
    <span class="n">L</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># List to hold cost values</span>

    <span class="c"># Simulate the system forward</span>
    <span class="k">while</span> <span class="n">mvi</span><span class="o">.</span><span class="n">t1</span> <span class="o">&lt;</span> <span class="n">tf</span><span class="o">-</span><span class="n">dt</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mvi</span><span class="o">.</span><span class="n">t1</span> <span class="o">&lt;</span> <span class="n">tau</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">uMax</span><span class="p">])</span> <span class="c"># Kick if necessary</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">KEnergy</span><span class="o">*</span><span class="n">eTilde</span><span class="p">])</span> <span class="c"># Swing-up controller</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="o">-</span><span class="n">dot</span><span class="p">(</span><span class="n">KStabilize</span><span class="p">,</span> <span class="n">xTilde</span><span class="p">)</span> <span class="c"># Stabilizing controller</span>
        <span class="n">u</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">uMax</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">uMax</span><span class="p">]),</span> <span class="n">u</span><span class="p">))</span> <span class="c"># Constrain input</span>

        <span class="n">dsys</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="c"># Step the system forward by one time step</span>

        <span class="c"># Update variables</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">k</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">TVec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">mvi</span><span class="o">.</span><span class="n">q1</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">xk</span>
        <span class="n">fdx</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">fdx</span><span class="p">()</span>
        <span class="n">xTilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wrapToPi</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xBar</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">total_energy</span><span class="p">()</span>
        <span class="n">eTilde</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">eBar</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">cost</span><span class="o">.</span><span class="n">l</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wrapTo2Pi</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span> <span class="n">u</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

        <span class="c"># Append to lists</span>
        <span class="n">K</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">Q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">Fdx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fdx</span><span class="p">)</span>
        <span class="n">E</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">U</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">L</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

    <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Fdx</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span>

<span class="c"># Optimize</span>
<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">Tau</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">JVec</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">JdTau</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s">&#39;Inf&#39;</span><span class="p">)</span>
<span class="k">while</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">JdTau</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mo">001</span><span class="p">:</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c"># Simulate forward from 0 to tf</span>
    <span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Fdx</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span> <span class="o">=</span> <span class="n">simulateForward</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">dsys</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">xBar</span><span class="p">)</span>

    <span class="c"># Simulate backward from tf to tau</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">K</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">lam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="k">while</span> <span class="n">T</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tau</span> <span class="o">+</span> <span class="n">dt</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
       <span class="n">lamDx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cost</span><span class="o">.</span><span class="n">l_dx</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">U</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">k</span><span class="p">)])</span>
       <span class="n">f2Dx</span> <span class="o">=</span> <span class="n">Fdx</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
       <span class="n">lamDt</span> <span class="o">=</span> <span class="o">-</span><span class="n">lamDx</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="n">f2Dx</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">lam</span><span class="p">)</span>
       <span class="n">lam</span> <span class="o">=</span> <span class="n">lam</span> <span class="o">-</span> <span class="n">lamDt</span><span class="o">*</span><span class="n">dt</span>
       <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c"># Calculate dynamics of swing-up controller at switching time</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">xTilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">wrapToPi</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">xBar</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="o">-</span><span class="n">dot</span><span class="p">(</span><span class="n">KStabilize</span><span class="p">,</span> <span class="n">xTilde</span><span class="p">)</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">uMax</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">uMax</span><span class="p">]),</span> <span class="n">u1</span><span class="p">))</span>
    <span class="n">dsys</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">u1</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">f</span><span class="p">()</span>

    <span class="c"># Calculate dynamics of stabilizing controller at switching time</span>
    <span class="n">eTilde</span> <span class="o">=</span> <span class="n">E</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">eBar</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">KEnergy</span><span class="o">*</span><span class="n">eTilde</span><span class="p">])</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">uMax</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">uMax</span><span class="p">]),</span> <span class="n">u2</span><span class="p">))</span>
    <span class="n">dsys</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">u2</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">dsys</span><span class="o">.</span><span class="n">f</span><span class="p">()</span>

    <span class="c"># Calculate value  of change in cost to change in switch time</span>
    <span class="n">JdTau</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">f1</span><span class="o">-</span><span class="n">f2</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>

    <span class="c"># Armijo - used to determine step size</span>
    <span class="n">chi</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="o">.</span><span class="mi">1</span>
    <span class="n">tauTemp</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">-</span> <span class="p">(</span><span class="n">alpha</span><span class="o">**</span><span class="n">chi</span><span class="p">)</span><span class="o">*</span><span class="n">JdTau</span>
    <span class="p">(</span><span class="n">KTemp</span><span class="p">,</span> <span class="n">TTemp</span><span class="p">,</span> <span class="n">QTemp</span><span class="p">,</span> <span class="n">XTemp</span><span class="p">,</span> <span class="n">FdxTemp</span><span class="p">,</span> <span class="n">ETemp</span><span class="p">,</span> <span class="n">UTemp</span><span class="p">,</span> <span class="n">LTemp</span><span class="p">,</span> <span class="n">JTemp</span><span class="p">)</span> <span class="o">=</span> <span class="n">simulateForward</span><span class="p">(</span><span class="n">tauTemp</span><span class="p">,</span> <span class="n">dsys</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">xBar</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">JTemp</span> <span class="o">&gt;</span> <span class="n">J</span> <span class="o">+</span> <span class="p">(</span><span class="n">alpha</span><span class="o">**</span><span class="n">chi</span><span class="p">)</span><span class="o">*</span><span class="n">beta</span><span class="o">*</span><span class="p">(</span><span class="n">JdTau</span><span class="o">**</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">tauTemp</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">-</span> <span class="p">(</span><span class="n">alpha</span><span class="o">**</span><span class="n">chi</span><span class="p">)</span><span class="o">*</span><span class="n">JdTau</span>
        <span class="p">(</span><span class="n">KTemp</span><span class="p">,</span> <span class="n">TTemp</span><span class="p">,</span> <span class="n">QTemp</span><span class="p">,</span> <span class="n">XTemp</span><span class="p">,</span> <span class="n">FdxTemp</span><span class="p">,</span> <span class="n">ETemp</span><span class="p">,</span> <span class="n">UTemp</span><span class="p">,</span> <span class="n">LTemp</span><span class="p">,</span> <span class="n">JTemp</span><span class="p">)</span> <span class="o">=</span> <span class="n">simulateForward</span><span class="p">(</span><span class="n">tauTemp</span><span class="p">,</span> <span class="n">dsys</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">xBar</span><span class="p">)</span>
        <span class="n">chi</span> <span class="o">=</span> <span class="n">chi</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">**</span><span class="n">chi</span> <span class="c"># Step size</span>

    <span class="c"># Calculate new switching time</span>
    <span class="n">tauPlus</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">-</span> <span class="n">gamma</span><span class="o">*</span><span class="n">JdTau</span>

    <span class="c"># Print iteration results</span>
    <span class="k">print</span> <span class="s">&quot;Optimization iteration: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">cnt</span>
    <span class="k">print</span> <span class="s">&quot;Current switch time: </span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">tau</span>
    <span class="k">print</span> <span class="s">&quot;New switch time: </span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">tauPlus</span>
    <span class="k">print</span> <span class="s">&quot;Current cost: </span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">J</span>
    <span class="k">print</span> <span class="s">&quot;Parital of cost to switch time: </span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">JdTau</span>
    <span class="k">print</span> <span class="s">&quot;&quot;</span>

    <span class="c"># Update to  new switching time</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="n">tauPlus</span>

<span class="k">print</span> <span class="s">&quot;Optimal switch time: </span><span class="si">%.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">tau</span>

<span class="c"># Simulate with optimal switching time</span>
<span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Fdx</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span> <span class="o">=</span> <span class="n">simulateForward</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">dsys</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">xBar</span><span class="p">)</span>

<span class="c"># Visualize the system in action</span>
<span class="n">trep</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">visualize_3d</span><span class="p">([</span> <span class="n">trep</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">VisualItem3D</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span> <span class="p">])</span>

<span class="c"># Plot results</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">311</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Swing-up and stabilize with optimal switching time&quot;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;X&quot;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s">&quot;qd&quot;</span><span class="p">,</span><span class="s">&quot;p&quot;</span><span class="p">])</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">312</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">U</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;T&quot;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;U&quot;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">313</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">L</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&quot;T&quot;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&quot;L&quot;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


          </div>
        </div>
      </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
    <h2><a href="http://murpheylab.github.io/trep/">Project Website</a></h2>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Calculate optimal switching time</a><ul>
<li><a class="reference internal" href="#create-pendulum-system">Create pendulum system</a></li>
<li><a class="reference internal" href="#create-cost">Create cost</a></li>
<li><a class="reference internal" href="#angle-utility-functions">Angle utility functions</a></li>
<li><a class="reference internal" href="#simulate-function">Simulate function</a></li>
<li><a class="reference internal" href="#optimize">Optimize</a></li>
<li><a class="reference internal" href="#simulate-with-optimal-switching-time">Simulate with optimal switching time</a></li>
<li><a class="reference internal" href="#visualize-the-system-in-action">Visualize the system in action</a></li>
<li><a class="reference internal" href="#optimalswitchingtime-py-code">optimalSwitchingTime.py code</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="energyShapingSwingupController.html"
                        title="previous chapter">Design energy shaping swing-up controller</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../user_guide/index.html"
                        title="next chapter">User&#8217;s Guide</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/tutorial/optimalSwitchingTime.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../user_guide/index.html" title="User’s Guide"
             >next</a> |</li>
        <li class="right" >
          <a href="energyShapingSwingupController.html" title="Design energy shaping swing-up controller"
             >previous</a> |</li>
        <li><a href="../index.html">trep documentation</a> &raquo;</li>
          <li><a href="index.html" >Tutorial</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Elliot Johnson.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>